Imports ECCore
Namespace ECCore

    Partial Public Class RiskSimulations
        Private mInverseLaplaceFunction As SortedDictionary(Of Double, Double) = Nothing
        Public ReadOnly Property InverseLaplaceFunction As SortedDictionary(Of Double, Double)
            Get
                If mInverseLaplaceFunction Is Nothing Then
                    mInverseLaplaceFunction = New SortedDictionary(Of Double, Double) From
                    {
                    {0, 0},
                    {0.00798, 0.01},
                    {0.01596, 0.02},
                    {0.02393, 0.03},
                    {0.03191, 0.04},
                    {0.03988, 0.05},
                    {0.04784, 0.06},
                    {0.05581, 0.07},
                    {0.06376, 0.08},
                    {0.07171, 0.09},
                    {0.07966, 0.1},
                    {0.08759, 0.11},
                    {0.09552, 0.12},
                    {0.10348, 0.13},
                    {0.11134, 0.14},
                    {0.11924, 0.15},
                    {0.12712, 0.16},
                    {0.13499, 0.17},
                    {0.14285, 0.18},
                    {0.15069, 0.19},
                    {0.15852, 0.2},
                    {0.16633, 0.21},
                    {0.17413, 0.22},
                    {0.18191, 0.23},
                    {0.18967, 0.24},
                    {0.19741, 0.25},
                    {0.20514, 0.26},
                    {0.21284, 0.27},
                    {0.22052, 0.28},
                    {0.22818, 0.29},
                    {0.23582, 0.3},
                    {0.24344, 0.31},
                    {0.25103, 0.32},
                    {0.2586, 0.33},
                    {0.26614, 0.34},
                    {0.27366, 0.35},
                    {0.28115, 0.36},
                    {0.28862, 0.37},
                    {0.29605, 0.38},
                    {0.30346, 0.39},
                    {0.31084, 0.4},
                    {0.31819, 0.41},
                    {0.32552, 0.42},
                    {0.3328, 0.43},
                    {0.34006, 0.44},
                    {0.34729, 0.45},
                    {0.35448, 0.46},
                    {0.36164, 0.47},
                    {0.36877, 0.48},
                    {0.37587, 0.49},
                    {0.38292, 0.5},
                    {0.38995, 0.51},
                    {0.39694, 0.52},
                    {0.40389, 0.53},
                    {0.4108, 0.54},
                    {0.41768, 0.55},
                    {0.42452, 0.56},
                    {0.43132, 0.57},
                    {0.43809, 0.58},
                    {0.44481, 0.59},
                    {0.45149, 0.6},
                    {0.45814, 0.61},
                    {0.46474, 0.62},
                    {0.47131, 0.63},
                    {0.47783, 0.64},
                    {0.48431, 0.65},
                    {0.49075, 0.66},
                    {0.49714, 0.67},
                    {0.5035, 0.68},
                    {0.50981, 0.69},
                    {0.51607, 0.7},
                    {0.5223, 0.71},
                    {0.52848, 0.72},
                    {0.53461, 0.73},
                    {0.5407, 0.74},
                    {0.54675, 0.75},
                    {0.55275, 0.76},
                    {0.5587, 0.77},
                    {0.56461, 0.78},
                    {0.57047, 0.79},
                    {0.57629, 0.8},
                    {0.58206, 0.81},
                    {0.58778, 0.82},
                    {0.59346, 0.83},
                    {0.59909, 0.84},
                    {0.60468, 0.85},
                    {0.61021, 0.86},
                    {0.6157, 0.87},
                    {0.62114, 0.88},
                    {0.62653, 0.89},
                    {0.63188, 0.9},
                    {0.63718, 0.91},
                    {0.64243, 0.92},
                    {0.64763, 0.93},
                    {0.65278, 0.94},
                    {0.65789, 0.95},
                    {0.66294, 0.96},
                    {0.66795, 0.97},
                    {0.67291, 0.98},
                    {0.67783, 0.99},
                    {0.68269, 1},
                    {0.6875, 1.01},
                    {0.69227, 1.02},
                    {0.69699, 1.03},
                    {0.70166, 1.04},
                    {0.70628, 1.05},
                    {0.71086, 1.06},
                    {0.71538, 1.07},
                    {0.71986, 1.08},
                    {0.72429, 1.09},
                    {0.72867, 1.1},
                    {0.733, 1.11},
                    {0.73729, 1.12},
                    {0.74152, 1.13},
                    {0.74571, 1.14},
                    {0.74986, 1.15},
                    {0.75395, 1.16},
                    {0.758, 1.17},
                    {0.762, 1.18},
                    {0.76595, 1.19},
                    {0.76986, 1.2},
                    {0.77372, 1.21},
                    {0.77754, 1.22},
                    {0.7813, 1.23},
                    {0.78502, 1.24},
                    {0.7887, 1.25},
                    {0.79233, 1.26},
                    {0.79592, 1.27},
                    {0.79945, 1.28},
                    {0.80295, 1.29},
                    {0.8064, 1.3},
                    {0.8098, 1.31},
                    {0.81316, 1.32},
                    {0.81648, 1.33},
                    {0.81975, 1.34},
                    {0.82298, 1.35},
                    {0.82617, 1.36},
                    {0.82931, 1.37},
                    {0.83241, 1.38},
                    {0.83547, 1.39},
                    {0.83849, 1.4},
                    {0.84146, 1.41},
                    {0.84439, 1.42},
                    {0.84728, 1.43},
                    {0.85013, 1.44},
                    {0.85294, 1.45},
                    {0.85571, 1.46},
                    {0.85844, 1.47},
                    {0.86113, 1.48},
                    {0.86378, 1.49},
                    {0.86639, 1.5},
                    {0.86696, 1.51},
                    {0.87149, 1.52},
                    {0.87398, 1.53},
                    {0.87644, 1.54},
                    {0.87886, 1.55},
                    {0.88124, 1.56},
                    {0.88358, 1.57},
                    {0.88589, 1.58},
                    {0.88817, 1.59},
                    {0.8904, 1.6},
                    {0.8926, 1.61},
                    {0.89477, 1.62},
                    {0.8969, 1.63},
                    {0.89899, 1.64},
                    {0.90106, 1.65},
                    {0.90309, 1.66},
                    {0.90508, 1.67},
                    {0.90704, 1.68},
                    {0.90897, 1.69},
                    {0.91087, 1.7},
                    {0.91273, 1.71},
                    {0.91457, 1.72},
                    {0.91637, 1.73},
                    {0.91814, 1.74},
                    {0.91988, 1.75},
                    {0.92159, 1.76},
                    {0.92327, 1.77},
                    {0.92492, 1.78},
                    {0.92655, 1.79},
                    {0.92814, 1.8},
                    {0.9297, 1.81},
                    {0.93124, 1.82},
                    {0.93275, 1.83},
                    {0.93423, 1.84},
                    {0.93569, 1.85},
                    {0.93711, 1.86},
                    {0.93852, 1.87},
                    {0.93989, 1.88},
                    {0.94124, 1.89},
                    {0.94257, 1.9},
                    {0.94387, 1.91},
                    {0.94514, 1.92},
                    {0.94639, 1.93},
                    {0.94762, 1.94},
                    {0.94882, 1.95},
                    {0.95, 1.96},
                    {0.95116, 1.97},
                    {0.9523, 1.98},
                    {0.95341, 1.99},
                    {0.9545, 2},
                    {0.95557, 2.01},
                    {0.95662, 2.02},
                    {0.95764, 2.03},
                    {0.95865, 2.04},
                    {0.95964, 2.05},
                    {0.9606, 2.06},
                    {0.96155, 2.07},
                    {0.96247, 2.08},
                    {0.96338, 2.09},
                    {0.96427, 2.1},
                    {0.96514, 2.11},
                    {0.96599, 2.12},
                    {0.96683, 2.13},
                    {0.96765, 2.14},
                    {0.96844, 2.15},
                    {0.96923, 2.16},
                    {0.96999, 2.17},
                    {0.97074, 2.18},
                    {0.97148, 2.19},
                    {0.97219, 2.2},
                    {0.97289, 2.21},
                    {0.97358, 2.22},
                    {0.97425, 2.23},
                    {0.97491, 2.24},
                    {0.97555, 2.25},
                    {0.97618, 2.26},
                    {0.97679, 2.27},
                    {0.97739, 2.28},
                    {0.97798, 2.29},
                    {0.97855, 2.3},
                    {0.97911, 2.31},
                    {0.97966, 2.32},
                    {0.98019, 2.33},
                    {0.98072, 2.34},
                    {0.98123, 2.35},
                    {0.98172, 2.36},
                    {0.98221, 2.37},
                    {0.98269, 2.38},
                    {0.98315, 2.39},
                    {0.9836, 2.4},
                    {0.98405, 2.41},
                    {0.98448, 2.42},
                    {0.9849, 2.43},
                    {0.98531, 2.44},
                    {0.98571, 2.45},
                    {0.98611, 2.46},
                    {0.98649, 2.47},
                    {0.98686, 2.48},
                    {0.98723, 2.49},
                    {0.98758, 2.5},
                    {0.98793, 2.51},
                    {0.98826, 2.52},
                    {0.98859, 2.53},
                    {0.98891, 2.54},
                    {0.98923, 2.55},
                    {0.98953, 2.56},
                    {0.98983, 2.57},
                    {0.99012, 2.58},
                    {0.9904, 2.59},
                    {0.99068, 2.6},
                    {0.99095, 2.61},
                    {0.99121, 2.62},
                    {0.99146, 2.63},
                    {0.99171, 2.64},
                    {0.99195, 2.65},
                    {0.99219, 2.66},
                    {0.99241, 2.67},
                    {0.99263, 2.68},
                    {0.99285, 2.69},
                    {0.99307, 2.7},
                    {0.99327, 2.71},
                    {0.99347, 2.72},
                    {0.99367, 2.73},
                    {0.99386, 2.74},
                    {0.99404, 2.75},
                    {0.99422, 2.76},
                    {0.99439, 2.77},
                    {0.99456, 2.78},
                    {0.99473, 2.79},
                    {0.99489, 2.8},
                    {0.99505, 2.81},
                    {0.9952, 2.82},
                    {0.99535, 2.83},
                    {0.99549, 2.84},
                    {0.99563, 2.85},
                    {0.99576, 2.86},
                    {0.9959, 2.87},
                    {0.99602, 2.88},
                    {0.99615, 2.89},
                    {0.99627, 2.9},
                    {0.99639, 2.91},
                    {0.9965, 2.92},
                    {0.99661, 2.93},
                    {0.99672, 2.94},
                    {0.99682, 2.95},
                    {0.99692, 2.96},
                    {0.99702, 2.97},
                    {0.99712, 2.98},
                    {0.99721, 2.99},
                    {0.9973, 3},
                    {0.99739, 3.01},
                    {0.99747, 3.02},
                    {0.99755, 3.03},
                    {0.99763, 3.04},
                    {0.99771, 3.05},
                    {0.99779, 3.06},
                    {0.99786, 3.07},
                    {0.99793, 3.08},
                    {0.998, 3.09},
                    {0.99806, 3.1},
                    {0.99813, 3.11},
                    {0.99819, 3.12},
                    {0.99825, 3.13},
                    {0.99831, 3.14},
                    {0.99837, 3.15},
                    {0.99842, 3.16},
                    {0.99848, 3.17},
                    {0.99853, 3.18},
                    {0.99858, 3.19},
                    {0.99863, 3.2},
                    {0.99867, 3.21},
                    {0.99872, 3.22},
                    {0.99876, 3.23},
                    {0.9988, 3.24},
                    {0.99855, 3.25},
                    {0.99889, 3.26},
                    {0.99892, 3.27},
                    {0.99896, 3.28},
                    {0.999, 3.29},
                    {0.99903, 3.3},
                    {0.99907, 3.31},
                    {0.9991, 3.32},
                    {0.99913, 3.33},
                    {0.99916, 3.34},
                    {0.99919, 3.35},
                    {0.99922, 3.36},
                    {0.99925, 3.37},
                    {0.99928, 3.38},
                    {0.9993, 3.39},
                    {0.99933, 3.4},
                    {0.99935, 3.41},
                    {0.99937, 3.42},
                    {0.9994, 3.43},
                    {0.99942, 3.44},
                    {0.99944, 3.45},
                    {0.99946, 3.46},
                    {0.99948, 3.47},
                    {0.9995, 3.48},
                    {0.99952, 3.49},
                    {0.99953, 3.5},
                    {0.99955, 3.51},
                    {0.99957, 3.52},
                    {0.99958, 3.53},
                    {0.9996, 3.54},
                    {0.99961, 3.55},
                    {0.99963, 3.56},
                    {0.99964, 3.57},
                    {0.99966, 3.58},
                    {0.99967, 3.59},
                    {0.99968, 3.6},
                    {0.99969, 3.61},
                    {0.99971, 3.62},
                    {0.99972, 3.63},
                    {0.99973, 3.64},
                    {0.99974, 3.65},
                    {0.99975, 3.66},
                    {0.99976, 3.67},
                    {0.99977, 3.68},
                    {0.9997801, 3.69},
                    {0.9997802, 3.7},
                    {0.99979, 3.71},
                    {0.9998, 3.72},
                    {0.99981, 3.73},
                    {0.9998201, 3.74},
                    {0.9998202, 3.75},
                    {0.99983, 3.76},
                    {0.9998401, 3.77},
                    {0.9998402, 3.78},
                    {0.99985, 3.79},
                    {0.9998601, 3.8},
                    {0.9998602, 3.81},
                    {0.9998701, 3.82},
                    {0.9998702, 3.83},
                    {0.9998801, 3.84},
                    {0.9998802, 3.85},
                    {0.9998901, 3.86},
                    {0.9998902, 3.87},
                    {0.999901, 3.88},
                    {0.999902, 3.89},
                    {0.999903, 3.9},
                    {0.9999101, 3.91},
                    {0.9999102, 3.92},
                    {0.9999201, 3.93},
                    {0.9999202, 3.94},
                    {0.9999203, 3.95},
                    {0.9999204, 3.96},
                    {0.9999301, 3.97},
                    {0.9999302, 3.98},
                    {0.9999303, 3.99},
                    {1, 4}
                    }
                End If
                Return mInverseLaplaceFunction
            End Get
        End Property
        Public Property NumSimulationsEstimationEspilon As Double = 0.01
        Public Property NumSimulationsEstimationProbability As Double = 0.95

        Private Sub GenerateReserveLaplaceFunction()
        End Sub

        Private Function GetInverseLaplace(value As Double) As Double
            If value > 4 Then Return 1
            Dim kvp As KeyValuePair(Of Double, Double) = InverseLaplaceFunction.FirstOrDefault(Function(x) x.Key >= value)
            If kvp.Key = value Then Return kvp.Value
            Dim kvpNext As KeyValuePair(Of Double, Double) = InverseLaplaceFunction.FirstOrDefault(Function(x) x.Value = kvp.Value + 0.01)
            Dim k As Double = (kvpNext.Value - kvp.Value) / (kvpNext.Key - kvp.Key)
            Dim b As Double = kvp.Value - k * kvp.Key
            Return k * value + b
        End Function

        Private Function GetNumberOfSimulationsEstimation(likelihoodValue As Double) As Integer
            Return likelihoodValue * (1 - likelihoodValue) * Math.Pow(GetInverseLaplace(NumSimulationsEstimationProbability) / NumSimulationsEstimationEspilon, 2)
        End Function

        Public Function GetEstimatedNumberOfSimulations() As Integer
            Simulate()
            Dim max As Double = 0
            Dim v As Double
            For Each likelihood As Double In computedLikelihoods.Values
                v = GetNumberOfSimulationsEstimation(likelihood)
                If v > max Then max = v
            Next
            Return max
        End Function
    End Class
End Namespace
